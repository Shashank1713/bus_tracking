<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Login | Bus Tracking</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg-a: #03111f;
      --bg-b: #0d2946;
      --card: rgba(9, 34, 59, 0.84);
      --text: #f8fafc;
      --muted: #cbd5e1;
      --accent: #f59e0b;
      --accent-dark: #d97706;
      --danger: #fda4af;
      --ok: #86efac;
    }

    * {
      box-sizing: border-box;
      font-family: Manrope, sans-serif;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: grid;
      place-items: center;
      color: var(--text);
      background:
        radial-gradient(circle at 10% 10%, rgba(245, 158, 11, 0.14), transparent 30%),
        radial-gradient(circle at 90% 80%, rgba(56, 189, 248, 0.12), transparent 40%),
        linear-gradient(120deg, var(--bg-a), var(--bg-b));
      padding: 20px;
    }

    .card {
      width: min(460px, 100%);
      background: var(--card);
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 28px 80px rgba(2, 6, 23, 0.55);
      backdrop-filter: blur(8px);
      animation: rise 280ms ease-out;
    }

    @keyframes rise {
      from { transform: translateY(10px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    h1 {
      margin: 0 0 8px;
      font-size: 1.5rem;
      font-weight: 700;
    }

    p {
      margin: 0 0 20px;
      color: var(--muted);
      font-size: 0.94rem;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-size: 0.9rem;
      font-weight: 600;
    }

    .mobile-wrap {
      display: grid;
      grid-template-columns: 74px 1fr;
      gap: 8px;
    }

    .code {
      border-radius: 12px;
      border: 1px solid rgba(203, 213, 225, 0.2);
      background: rgba(15, 23, 42, 0.45);
      color: var(--muted);
      display: grid;
      place-items: center;
      font-weight: 700;
    }

    input,
    select {
      width: 100%;
      border: 1px solid rgba(203, 213, 225, 0.2);
      background: rgba(15, 23, 42, 0.45);
      color: var(--text);
      border-radius: 12px;
      padding: 12px;
      outline: none;
      font-size: 1rem;
      transition: border-color 150ms ease;
    }

    input:focus,
    select:focus {
      border-color: #38bdf8;
    }

    .stack {
      display: grid;
      gap: 14px;
    }

    .actions {
      display: grid;
      gap: 10px;
      margin-top: 16px;
    }

    button {
      border: 0;
      padding: 12px 14px;
      border-radius: 12px;
      font-size: 0.95rem;
      font-weight: 700;
      color: #0f172a;
      background: var(--accent);
      cursor: pointer;
      transition: background 120ms ease;
    }

    button:hover {
      background: var(--accent-dark);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    #status {
      min-height: 22px;
      font-size: 0.9rem;
      margin-top: 8px;
      color: var(--muted);
    }

    #meta {
      min-height: 18px;
      font-size: 0.82rem;
      color: var(--muted);
      margin-top: 4px;
    }

    #status.error {
      color: var(--danger);
    }

    #status.success {
      color: var(--ok);
    }
  </style>
</head>
<body>
  <main class="card">
    <h1>OTP Login</h1>
    <p>Use Email OTP or Mobile OTP based on your server configuration.</p>

    <div class="stack">
      <div>
        <label for="mode">Login Method</label>
        <select id="mode">
          <option value="email">Email OTP</option>
          <option value="mobile">Mobile OTP</option>
        </select>
      </div>
    </div>

    <div class="stack">
      <div id="emailWrap">
        <label for="email">Email Address</label>
        <input id="email" type="email" placeholder="you@gmail.com" autocomplete="email" />
      </div>

      <div id="mobileWrap" hidden>
        <label for="mobile">Mobile Number</label>
        <div class="mobile-wrap">
          <div class="code">+91</div>
          <input id="mobile" type="tel" maxlength="10" placeholder="9876543210" inputmode="numeric" />
        </div>
      </div>

      <div>
        <label for="otp">OTP</label>
        <input id="otp" type="text" maxlength="6" placeholder="Enter 6-digit OTP" inputmode="numeric" />
      </div>
    </div>

    <div class="actions">
      <button id="sendBtn" type="button">Send OTP</button>
      <button id="verifyBtn" type="button">Verify OTP</button>
    </div>

    <div id="status"></div>
    <div id="meta"></div>
  </main>

  <script>
    const statusEl = document.getElementById("status");
    const metaEl = document.getElementById("meta");
    const sendBtn = document.getElementById("sendBtn");
    const verifyBtn = document.getElementById("verifyBtn");
    const modeSelect = document.getElementById("mode");
    const emailWrap = document.getElementById("emailWrap");
    const mobileWrap = document.getElementById("mobileWrap");
    const emailInput = document.getElementById("email");
    const mobileInput = document.getElementById("mobile");
    const otpInput = document.getElementById("otp");
    const RESEND_SECONDS = 30;
    let resendTimer = null;
    let sentAt = null;
    let otpReady = false;
    let capabilities = {
      emailOtpEnabled: true,
      smsOtpEnabled: false
    };

    function setStatus(message, type) {
      statusEl.textContent = message || "";
      statusEl.className = type || "";
    }

    function normalizeEmail() {
      const email = emailInput.value.trim().toLowerCase();
      emailInput.value = email;
      if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        throw new Error("Enter a valid email address.");
      }
      return email;
    }

    function normalizeMobile() {
      const mobile = mobileInput.value.trim().replace(/\D/g, "");
      mobileInput.value = mobile;
      if (!/^[6-9]\d{9}$/.test(mobile)) {
        throw new Error("Enter a valid 10-digit Indian mobile number.");
      }
      return mobile;
    }

    function mapApiError(errorMessage) {
      if (!errorMessage) return "Something went wrong. Please try again.";
      return errorMessage;
    }

    function setMeta(text) {
      metaEl.textContent = text || "";
    }

    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    function activeMode() {
      return modeSelect.value === "mobile" ? "mobile" : "email";
    }

    function resetOtpState() {
      otpReady = false;
      verifyBtn.disabled = true;
      setStatus("", "");
      setMeta("");
      if (resendTimer) {
        clearInterval(resendTimer);
        resendTimer = null;
      }
      sendBtn.disabled = false;
      sendBtn.textContent = "Send OTP";
    }

    function refreshModeUi() {
      const mode = activeMode();
      emailWrap.hidden = mode !== "email";
      mobileWrap.hidden = mode !== "mobile";
      resetOtpState();
    }

    function applyCapabilityDefaults() {
      if (capabilities.emailOtpEnabled) {
        modeSelect.value = "email";
        return;
      }
      if (capabilities.smsOtpEnabled) {
        modeSelect.value = "mobile";
        return;
      }
      sendBtn.disabled = true;
      verifyBtn.disabled = true;
      setStatus("No OTP provider is configured on server.", "error");
      setMeta("Enable Gmail SMTP or FAST2SMS in Render environment variables.");
    }

    async function loadAuthCapabilities() {
      try {
        const res = await fetch("/api/config/auth-capabilities");
        if (!res.ok) return;
        capabilities = await res.json();
        applyCapabilityDefaults();
        refreshModeUi();
      } catch (error) {
        // Ignore capability check failures and allow normal flow.
      }
    }

    function startResendCooldown() {
      if (resendTimer) {
        clearInterval(resendTimer);
      }

      let remaining = RESEND_SECONDS;
      sendBtn.disabled = true;
      sendBtn.textContent = `Resend in ${remaining}s`;

      resendTimer = setInterval(() => {
        remaining -= 1;
        if (remaining <= 0) {
          clearInterval(resendTimer);
          resendTimer = null;
          sendBtn.disabled = false;
          sendBtn.textContent = "Send OTP";
          return;
        }
        sendBtn.textContent = `Resend in ${remaining}s`;
      }, 1000);
    }

    async function sendOtp() {
      setStatus("", "");
      if (resendTimer) {
        return;
      }
      sendBtn.disabled = true;
      verifyBtn.disabled = true;
      otpReady = false;

      try {
        const mode = activeMode();
        let res;
        if (mode === "mobile") {
          if (!capabilities.smsOtpEnabled) {
            throw new Error("Mobile OTP is not configured on server.");
          }
          const mobile = normalizeMobile();
          res = await fetch("/api/send-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mobile })
          });
        } else {
          if (!capabilities.emailOtpEnabled) {
            throw new Error("Email OTP is not configured on server.");
          }
          const email = normalizeEmail();
          res = await fetch("/api/auth/email/send-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email })
          });
        }

        const payload = await res.json();
        if (!res.ok) {
          throw new Error(payload.error || "Failed to send OTP.");
        }

        sentAt = new Date();
        setMeta(`OTP sent at ${formatTime(sentAt)}. It expires in 5 minutes.`);
        setStatus(activeMode() === "mobile" ? "OTP sent to your mobile." : "OTP sent to your email.", "success");
        otpReady = true;
        verifyBtn.disabled = false;
        startResendCooldown();
      } catch (error) {
        setStatus(mapApiError(error.message), "error");
        setMeta("");
        otpReady = false;
        verifyBtn.disabled = true;
        sendBtn.disabled = false;
      } finally {
        if (!resendTimer) {
          sendBtn.disabled = false;
        }
      }
    }

    async function verifyOtp() {
      setStatus("", "");
      verifyBtn.disabled = true;

      try {
        if (!otpReady) {
          throw new Error("Send OTP first.");
        }
        const mode = activeMode();
        const otp = otpInput.value.trim();
        if (!/^\d{6}$/.test(otp)) {
          throw new Error("Enter a valid 6-digit OTP.");
        }

        let res;
        if (mode === "mobile") {
          const mobile = normalizeMobile();
          res = await fetch("/api/verify-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ mobile, otp })
          });
        } else {
          const email = normalizeEmail();
          res = await fetch("/api/auth/email/verify-otp", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, otp })
          });
        }

        const payload = await res.json();
        if (!res.ok) {
          throw new Error(payload.error || "OTP verification failed.");
        }

        localStorage.setItem("appToken", payload.token);
        localStorage.setItem("identity", payload.user.email || payload.user.mobile || "");
        window.location.href = payload.redirect || "/auth.html";
      } catch (error) {
        setStatus(mapApiError(error.message), "error");
      } finally {
        verifyBtn.disabled = !otpReady;
      }
    }

    sendBtn.addEventListener("click", sendOtp);
    verifyBtn.addEventListener("click", verifyOtp);
    modeSelect.addEventListener("change", refreshModeUi);
    verifyBtn.disabled = true;
    applyCapabilityDefaults();
    refreshModeUi();
    loadAuthCapabilities();
  </script>
</body>
</html>
