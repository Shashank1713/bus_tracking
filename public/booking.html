<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Book Ticket</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;700;800&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #eef2f8;
      --card: #fff;
      --line: #d7dfec;
      --text: #1a2238;
      --muted: #68738a;
      --blue: #2f43a6;
      --yellow: #f5cf0d;
      --danger: #b13d3d;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: Manrope, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
    }

    .wrap {
      width: min(1240px, calc(100% - 2rem));
      margin: 18px auto;
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 14px;
      align-items: start;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px;
      box-shadow: 0 8px 24px rgba(22, 36, 67, 0.08);
    }

    h1 {
      font-size: 1.45rem;
      color: var(--blue);
      margin-bottom: 10px;
    }

    .meta {
      color: var(--muted);
      font-weight: 700;
      display: grid;
      gap: 4px;
      margin-bottom: 14px;
    }

    .seat-grid {
      display: grid;
      grid-template-columns: repeat(4, minmax(54px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .seat {
      min-height: 42px;
      border: 1px solid #b8c4e7;
      border-radius: 10px;
      background: #f5f8ff;
      color: #2a3768;
      font-weight: 800;
      cursor: pointer;
    }

    .seat.booked {
      background: #f4d7d7;
      border-color: #d7a9a9;
      color: #9e5a5a;
      cursor: not-allowed;
    }

    .seat.selected {
      background: #2f43a6;
      color: #fff;
      border-color: #2f43a6;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
      color: #4f5d79;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 4px;
      vertical-align: middle;
    }

    .dot.available { background: #dfe8ff; }
    .dot.selected { background: #2f43a6; }
    .dot.booked { background: #d7a9a9; }

    .section-title {
      font-size: 1.1rem;
      font-weight: 800;
      color: var(--blue);
      margin-bottom: 8px;
    }

    .msg {
      min-height: 42px;
      border-radius: 10px;
      border: 1px solid #d7dfec;
      background: #f9fbff;
      color: #51607c;
      padding: 10px;
      font-size: 0.92rem;
      font-weight: 700;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
    }

    .msg.error {
      border-color: #edb8b8;
      background: #fff3f3;
      color: var(--danger);
    }

    .passenger-block {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 10px;
      background: #fcfdff;
    }

    .passenger-grid {
      display: grid;
      grid-template-columns: 1.5fr 80px 130px;
      gap: 8px;
      margin-top: 8px;
    }

    input,
    select {
      width: 100%;
      min-height: 40px;
      border-radius: 10px;
      border: 1px solid #cfd8ea;
      padding: 0 10px;
      font-size: 0.95rem;
      background: #fff;
    }

    .summary {
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 12px;
      background: #f8faff;
      display: grid;
      gap: 6px;
      font-weight: 700;
      color: #475573;
      margin-bottom: 10px;
    }

    .summary .amount {
      color: #111a33;
      font-size: 1.2rem;
      font-weight: 900;
    }

    .btn-row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      min-height: 44px;
      border: none;
      border-radius: 999px;
      font-size: 0.96rem;
      font-weight: 800;
      padding: 0 18px;
      cursor: pointer;
    }

    .btn.back {
      background: #e8edf9;
      color: #31488e;
    }

    .btn.pay {
      background: var(--yellow);
      color: #171f34;
    }

    @media (max-width: 980px) {
      .wrap {
        grid-template-columns: 1fr;
      }

      .passenger-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card">
      <h1>Seat Selection</h1>
      <div id="trip-meta" class="meta">Loading trip details...</div>
      <div id="seat-grid" class="seat-grid"></div>
      <div class="legend">
        <span><i class="dot available"></i>Available</span>
        <span><i class="dot selected"></i>Selected</span>
        <span><i class="dot booked"></i>Booked</span>
      </div>
    </section>

    <section class="card">
      <h1>Passenger Details</h1>
      <div id="message" class="msg">Select seats to continue.</div>
      <div id="passenger-forms"></div>

      <div class="summary">
        <p>Selected Seats: <span id="selected-seats">-</span></p>
        <p>Fare Per Seat: <span id="fare-per-seat">Rs 0</span></p>
        <p class="amount">Total: <span id="total-amount">Rs 0</span></p>
      </div>

      <div class="btn-row">
        <button class="btn back" type="button" onclick="window.history.back()">Back</button>
        <button id="pay-book" class="btn pay" type="button">Pay & Confirm Booking</button>
      </div>
    </section>
  </main>

  <script>
    const appToken = localStorage.getItem("appToken");
    if (!appToken) {
      window.location.href = "login.html";
    }

    const params = new URLSearchParams(window.location.search);
    const tripId = params.get("tripId");

    const tripMetaEl = document.getElementById("trip-meta");
    const seatGridEl = document.getElementById("seat-grid");
    const messageEl = document.getElementById("message");
    const passengerFormsEl = document.getElementById("passenger-forms");
    const selectedSeatsEl = document.getElementById("selected-seats");
    const farePerSeatEl = document.getElementById("fare-per-seat");
    const totalAmountEl = document.getElementById("total-amount");

    let trip = null;
    let selectedSeats = [];

    function setMessage(text, isError = false) {
      messageEl.textContent = text;
      messageEl.classList.toggle("error", isError);
    }

    function seatList(totalSeats) {
      const seats = [];
      for (let row = 1; row <= Math.ceil(totalSeats / 4); row += 1) {
        for (let col = 1; col <= 4; col += 1) {
          const seat = `S${(row - 1) * 4 + col}`;
          if ((row - 1) * 4 + col <= totalSeats) seats.push(seat);
        }
      }
      return seats;
    }

    function renderPassengerForms() {
      passengerFormsEl.innerHTML = "";
      if (!selectedSeats.length) {
        selectedSeatsEl.textContent = "-";
        totalAmountEl.textContent = "Rs 0";
        return;
      }

      selectedSeatsEl.textContent = selectedSeats.join(", ");
      totalAmountEl.textContent = `Rs ${trip.fare * selectedSeats.length}`;

      selectedSeats.forEach((seat) => {
        const block = document.createElement("div");
        block.className = "passenger-block";
        block.innerHTML = `
          <p class="section-title">Passenger - ${seat}</p>
          <div class="passenger-grid" data-seat="${seat}">
            <input type="text" data-field="name" placeholder="Full Name" />
            <input type="number" min="1" data-field="age" placeholder="Age" />
            <select data-field="gender">
              <option value="">Gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
        `;
        passengerFormsEl.appendChild(block);
      });
    }

    function toggleSeat(seat) {
      if (selectedSeats.includes(seat)) {
        selectedSeats = selectedSeats.filter((item) => item !== seat);
      } else {
        selectedSeats.push(seat);
      }
      renderSeats();
      renderPassengerForms();
      setMessage("Fill passenger details and confirm booking.");
    }

    function renderSeats() {
      seatGridEl.innerHTML = "";
      const allSeats = seatList(trip.totalSeats);
      const booked = new Set(trip.bookedSeats || []);

      allSeats.forEach((seat) => {
        const button = document.createElement("button");
        button.type = "button";
        button.className = "seat";
        button.textContent = seat;

        if (booked.has(seat)) {
          button.classList.add("booked");
          button.disabled = true;
        } else if (selectedSeats.includes(seat)) {
          button.classList.add("selected");
        }

        button.addEventListener("click", () => toggleSeat(seat));
        seatGridEl.appendChild(button);
      });
    }

    async function loadTrip() {
      if (!tripId) {
        setMessage("Trip not specified", true);
        return;
      }

      try {
        const response = await fetch(`/api/trips/${encodeURIComponent(tripId)}`);
        const payload = await response.json();

        if (!response.ok) {
          setMessage(payload.error || "Unable to load trip", true);
          return;
        }

        trip = payload.trip;
        farePerSeatEl.textContent = `Rs ${trip.fare}`;

        const dep = new Date(trip.departureTime).toLocaleString();
        const arr = new Date(trip.arrivalTime).toLocaleString();
        tripMetaEl.innerHTML = `
          <p><b>${trip.operatorName} - ${trip.busId}</b></p>
          <p>${trip.source} to ${trip.destination}</p>
          <p>Departure: ${dep}</p>
          <p>Arrival: ${arr}</p>
          <p>Available Seats: ${trip.availableSeats}</p>
        `;

        renderSeats();
        renderPassengerForms();
        setMessage("Select seat(s) to continue.");
      } catch (error) {
        setMessage("Failed to fetch trip", true);
      }
    }

    function collectPassengers() {
      const passengers = [];
      const blocks = Array.from(document.querySelectorAll(".passenger-grid"));

      for (const block of blocks) {
        const name = block.querySelector('[data-field="name"]').value.trim();
        const age = Number(block.querySelector('[data-field="age"]').value);
        const gender = block.querySelector('[data-field="gender"]').value;
        if (!name || !Number.isFinite(age) || age <= 0 || !gender) {
          return null;
        }
        passengers.push({ name, age, gender });
      }

      return passengers;
    }

    async function bookNow() {
      if (!trip) return;
      if (!selectedSeats.length) {
        setMessage("Please select at least one seat", true);
        return;
      }

      const passengers = collectPassengers();
      if (!passengers) {
        setMessage("Please fill valid passenger details for all selected seats", true);
        return;
      }

      const amount = trip.fare * selectedSeats.length;

      try {
        const orderRes = await fetch("/api/payments/create-order", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${appToken}`
          },
          body: JSON.stringify({ amount })
        });

        const orderPayload = await orderRes.json();
        if (!orderRes.ok) {
          setMessage(orderPayload.error || "Payment order failed", true);
          return;
        }

        const bookingRes = await fetch("/api/bookings", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            Authorization: `Bearer ${appToken}`
          },
          body: JSON.stringify({
            tripId: trip._id,
            seats: selectedSeats,
            passengers,
            paymentOrderId: orderPayload.orderId
          })
        });

        const bookingPayload = await bookingRes.json();
        if (!bookingRes.ok) {
          setMessage(bookingPayload.error || "Booking failed", true);
          return;
        }

        window.location.href = `my-bookings.html?pnr=${encodeURIComponent(bookingPayload.booking.pnr)}`;
      } catch (error) {
        setMessage("Unable to complete booking", true);
      }
    }

    document.getElementById("pay-book").addEventListener("click", bookNow);
    loadTrip();
  </script>
</body>
</html>
