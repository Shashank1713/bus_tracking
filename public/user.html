<!DOCTYPE html>
<html>
<head>
<title>User</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="/socket.io/socket.io.js"></script>
<script src="auth.js"></script>

<style>
html,body,#map{height:100%;margin:0;}
</style>
</head>
<body>

<script>requireRole("user");</script>
<div id="map"></div>

<script>
const socket = io();

const map = L.map("map").setView([0,0],2);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

const busIcon = L.icon({
  iconUrl: "https://cdn-icons-png.flaticon.com/512/61/61231.png",
  iconSize: [40,40],
  iconAnchor: [20,20]
});

let markers = {};
let centered = false;

socket.on("fleetUpdate", buses => {
    for (let id in buses) {
        const b = buses[id];
        if (!markers[id]) {
            markers[id] = L.marker([b.lat,b.lon],{icon:busIcon})
              .addTo(map)
              .bindPopup("Bus "+id);
            if (!centered) {
                map.setView([b.lat,b.lon],15);
                centered = true;
            }
        } else {
            markers[id].setLatLng([b.lat,b.lon]);
        }
    }
});
</script>

</body>
</html>
